Fix various issues with memory allocation error handling.  Patch by Zackery
Spytz.
