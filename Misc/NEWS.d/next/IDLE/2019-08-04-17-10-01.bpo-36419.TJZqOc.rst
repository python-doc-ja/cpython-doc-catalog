Refactor IDLE autocomplete and improve testing.
